<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reported Speech Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .header {
            background: #4f46e5;
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .timer {
            background: #ef4444;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .screen {
            padding: 30px;
            display: none;
        }

        #startScreen {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            border-color: #4f46e5;
            outline: none;
        }

        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 16px 30px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            font-weight: bold;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #4338ca;
        }

        .btn-submit {
            background: #10b981;
        }

        .btn-submit:hover {
            background: #0da271;
        }

        .btn-review {
            background: #f59e0b;
        }

        .btn-review:hover {
            background: #d97706;
        }

        .questions-container {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
            margin-bottom: 20px;
        }

        .questions-container::-webkit-scrollbar {
            width: 8px;
        }

        .questions-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .questions-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .question {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #4f46e5;
            transition: all 0.3s;
        }

        .question.correct {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .question.incorrect {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .question-number {
            font-weight: bold;
            color: #4f46e5;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .question-text {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
            line-height: 1.5;
        }

        .options {
            display: grid;
            gap: 8px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option:hover {
            border-color: #4f46e5;
            background: #f5f3ff;
        }

        .option.selected {
            border-color: #4f46e5;
            background: #eef2ff;
        }

        .option.correct-answer {
            border-color: #10b981;
            background: #d1fae5;
        }

        .option.wrong-answer {
            border-color: #ef4444;
            background: #fee2e2;
        }

        .option input {
            margin-right: 10px;
        }

        .option-label {
            font-weight: bold;
            color: #4f46e5;
            margin-right: 8px;
        }

        .result-screen {
            text-align: center;
            padding: 40px;
        }

        .score {
            font-size: 48px;
            font-weight: bold;
            color: #4f46e5;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress {
            height: 8px;
            background: #e5e7eb;
            margin: 20px 0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: #4f46e5;
            width: 0%;
            transition: width 0.3s;
        }

        .test-controls {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            flex: 1;
        }

        .review-container {
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .review-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
        }

        .refresh-warning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .warning-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .warning-box h3 {
            color: #ef4444;
            margin-bottom: 15px;
        }

        .warning-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .warning-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .warning-btn.cancel {
            background: #6b7280;
            color: white;
        }

        .warning-btn.confirm {
            background: #ef4444;
            color: white;
        }

        .back-to-start {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .back-to-start:hover {
            background: rgba(255,255,255,0.3);
        }

        .question-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
            font-weight: bold;
        }

        .status-correct {
            background: #d1fae5;
            color: #065f46;
        }

        .status-incorrect {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-unanswered {
            background: #f3f4f6;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <!-- Refresh Warning Modal -->
    <div class="refresh-warning" id="refreshWarning">
        <div class="warning-box">
            <h3>‚ö†Ô∏è Warning!</h3>
            <p>Are you sure you want to refresh? All your answers will be lost!</p>
            <div class="warning-buttons">
                <button class="warning-btn cancel" onclick="cancelRefresh()">Cancel</button>
                <button class="warning-btn confirm" onclick="confirmRefresh()">Refresh Anyway</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <button class="back-to-start" onclick="showStartScreen()" style="display: none;" id="backToStart">
                ‚Üê Back
            </button>
            <h1>üìù Reported Speech Test</h1>
            <p>All questions appear on one page. Submit when ready!</p>
        </div>

        <div class="timer" id="timer" style="display: none;">
            <span>‚è∞ Time Left:</span>
            <span id="time">15:00</span>
        </div>

        <!-- Start Screen -->
        <div class="screen" id="startScreen">
            <div class="form-group">
                <label>Enter your name:</label>
                <input type="text" id="studentName" placeholder="Enter your full name" required>
            </div>
            <button class="btn" onclick="startTest()">Start Test (15 minutes)</button>
        </div>

        <!-- Test Screen -->
        <div class="screen" id="testScreen">
            <div class="questions-container" id="questionsContainer">
                <!-- Questions will be loaded here -->
            </div>
            
            <div class="test-controls">
                <button class="control-btn" onclick="checkAllAnswered()" style="background: #8b5cf6; color: white;">
                    ‚úÖ Check Completion
                </button>
                <button class="control-btn btn-submit" onclick="submitTest()">
                    üì§ Submit Test
                </button>
            </div>
        </div>

        <!-- Loading Screen -->
        <div class="screen" id="loadingScreen">
            <div class="loading">
                <div class="spinner"></div>
                <p>Sending your report to Telegram...</p>
            </div>
        </div>

        <!-- Result Screen -->
        <div class="screen" id="resultScreen">
            <h2>üéØ Test Completed!</h2>
            <div class="score" id="finalScore">0/20</div>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="review-stats">
                <div class="stat-item">
                    <div class="stat-value" id="correctCount">0</div>
                    <div class="stat-label">Correct</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="incorrectCount">0</div>
                    <div class="stat-label">Incorrect</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="percentage">0%</div>
                    <div class="stat-label">Score</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="timeUsed">0:00</div>
                    <div class="stat-label">Time Used</div>
                </div>
            </div>
            
            <p id="resultMessage" style="margin: 20px 0; font-size: 1.1rem;"></p>
            
            <button class="btn btn-review" onclick="showReviewMode()" id="reviewBtn">
                üîç Review Answers
            </button>
            
            <button class="btn" onclick="location.reload()" style="margin-top: 15px; background: #6b7280;">
                üîÑ Take Test Again
            </button>
        </div>

        <!-- Review Screen -->
        <div class="screen" id="reviewScreen">
            <div class="review-header">
                <h2 style="color: #4f46e5;">üìã Answer Review</h2>
                <button class="control-btn" onclick="hideReviewMode()" style="background: #6b7280; color: white;">
                    ‚Üê Back to Results
                </button>
            </div>
            
            <div class="review-container" id="reviewContainer">
                <!-- Review content will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Test Configuration
        const TEST_DURATION = 900; // 15 minutes in seconds
        let timeLeft = TEST_DURATION;
        let timerInterval;
        let studentName = '';
        let score = 0;
        let answers = [];
        let testStarted = false;

        // Test Questions
        const questions = [
            {
                id: 1,
                question: "Direct: 'I am studying English,' she said.",
                options: [
                    "She said she is studying English.",
                    "She said she was studying English.",
                    "She said she studied English.",
                    "She said she has been studying English."
                ],
                correct: 1,
                explanation: "Present continuous (am studying) changes to past continuous (was studying)."
            },
            {
                id: 2,
                question: "Direct: 'We will visit Paris tomorrow,' they told us.",
                options: [
                    "They told us they will visit Paris tomorrow.",
                    "They told us they would visit Paris the next day.",
                    "They told us they visited Paris tomorrow.",
                    "They told us they would visit Paris tomorrow."
                ],
                correct: 1,
                explanation: "'will' changes to 'would' and 'tomorrow' changes to 'the next day'."
            },
            {
                id: 3,
                question: "Direct: 'I have finished my homework,' he said.",
                options: [
                    "He said he has finished his homework.",
                    "He said he had finished his homework.",
                    "He said he finished his homework.",
                    "He said he was finishing his homework."
                ],
                correct: 1,
                explanation: "Present perfect (have finished) changes to past perfect (had finished)."
            },
            {
                id: 4,
                question: "Direct: 'Can you help me?' she asked.",
                options: [
                    "She asked can I help her.",
                    "She asked if I could help her.",
                    "She asked could I help her.",
                    "She asked if I can help her."
                ],
                correct: 1,
                explanation: "Questions with 'can' change to 'if + could' in reported speech."
            },
            {
                id: 5,
                question: "Direct: 'Don't touch that!' he shouted.",
                options: [
                    "He shouted don't touch that.",
                    "He shouted to not touch that.",
                    "He shouted not to touch that.",
                    "He shouted that I shouldn't touch that."
                ],
                correct: 2,
                explanation: "Imperatives change to 'not to + infinitive' in reported speech."
            },
            {
                id: 6,
                question: "Direct: 'Where do you live?' he asked me.",
                options: [
                    "He asked me where do I live.",
                    "He asked me where I lived.",
                    "He asked me where did I live.",
                    "He asked me where I live."
                ],
                correct: 1,
                explanation: "Present simple (do live) changes to past simple (lived) in reported questions."
            },
            {
                id: 7,
                question: "Direct: 'I bought this car yesterday,' she said.",
                options: [
                    "She said she bought this car yesterday.",
                    "She said she had bought that car the previous day.",
                    "She said she bought that car yesterday.",
                    "She said she has bought this car the previous day."
                ],
                correct: 1,
                explanation: "'this' changes to 'that' and 'yesterday' changes to 'the previous day'."
            },
            {
                id: 8,
                question: "Direct: 'What time does the train leave?' they asked.",
                options: [
                    "They asked what time does the train leave.",
                    "They asked what time the train left.",
                    "They asked what time the train leaves.",
                    "They asked what time did the train leave."
                ],
                correct: 2,
                explanation: "For timetables and schedules, we can keep present simple in reported speech."
            },
            {
                id: 9,
                question: "Direct: 'I'm meeting John tonight,' she said.",
                options: [
                    "She said she is meeting John tonight.",
                    "She said she was meeting John that night.",
                    "She said she met John tonight.",
                    "She said she would meet John tonight."
                ],
                correct: 1,
                explanation: "Present continuous changes to past continuous, 'tonight' changes to 'that night'."
            },
            {
                id: 10,
                question: "Direct: 'You should see a doctor,' he told me.",
                options: [
                    "He told me I should see a doctor.",
                    "He told me you should see a doctor.",
                    "He told me I should have seen a doctor.",
                    "He told me you should have seen a doctor."
                ],
                correct: 0,
                explanation: "'you' changes to 'I' and modal 'should' doesn't change in reported speech."
            },
            {
                id: 11,
                question: "Direct: 'We have been waiting for hours,' they said.",
                options: [
                    "They said they have been waiting for hours.",
                    "They said they had been waiting for hours.",
                    "They said they were waiting for hours.",
                    "They said they waited for hours."
                ],
                correct: 1,
                explanation: "Present perfect continuous changes to past perfect continuous."
            },
            {
                id: 12,
                question: "Direct: 'Will you marry me?' he asked her.",
                options: [
                    "He asked her will you marry me.",
                    "He asked her if she would marry him.",
                    "He asked her would she marry him.",
                    "He asked her if she will marry him."
                ],
                correct: 1,
                explanation: "'will' changes to 'would' and 'you' changes to 'she', 'me' to 'him'."
            },
            {
                id: 13,
                question: "Direct: 'I can speak three languages,' she said.",
                options: [
                    "She said she can speak three languages.",
                    "She said she could speak three languages.",
                    "She said she speaks three languages.",
                    "She said she spoke three languages."
                ],
                correct: 1,
                explanation: "'can' changes to 'could' in reported speech."
            },
            {
                id: 14,
                question: "Direct: 'Don't forget to lock the door,' she reminded me.",
                options: [
                    "She reminded me don't forget to lock the door.",
                    "She reminded me not to forget to lock the door.",
                    "She reminded me to not forget locking the door.",
                    "She reminded me not forgetting to lock the door."
                ],
                correct: 1,
                explanation: "Negative imperatives change to 'not to + infinitive'."
            },
            {
                id: 15,
                question: "Direct: 'I was watching TV when you called,' he said.",
                options: [
                    "He said he was watching TV when I called.",
                    "He said he is watching TV when I called.",
                    "He said he had been watching TV when I called.",
                    "He said he watched TV when I called."
                ],
                correct: 0,
                explanation: "Past continuous usually stays the same in reported speech."
            },
            {
                id: 16,
                question: "Direct: 'How much does this cost?' she asked.",
                options: [
                    "She asked how much does this cost.",
                    "She asked how much that cost.",
                    "She asked how much that costs.",
                    "She asked how much this costs."
                ],
                correct: 2,
                explanation: "'this' changes to 'that' and present simple changes to past simple or stays."
            },
            {
                id: 17,
                question: "Direct: 'I'll call you later,' he promised.",
                options: [
                    "He promised I'll call you later.",
                    "He promised he would call me later.",
                    "He promised he will call me later.",
                    "He promised to call me later."
                ],
                correct: 1,
                explanation: "'will' changes to 'would', 'I' changes to 'he', 'you' changes to 'me'."
            },
            {
                id: 18,
                question: "Direct: 'We are going to the cinema,' they said.",
                options: [
                    "They said they are going to the cinema.",
                    "They said they were going to the cinema.",
                    "They said they go to the cinema.",
                    "They said they have gone to the cinema."
                ],
                correct: 1,
                explanation: "Present continuous changes to past continuous."
            },
            {
                id: 19,
                question: "Direct: 'Why did you leave early?' she asked him.",
                options: [
                    "She asked him why did you leave early.",
                    "She asked him why he had left early.",
                    "She asked him why he left early.",
                    "She asked him why had he left early."
                ],
                correct: 1,
                explanation: "Past simple (did leave) changes to past perfect (had left)."
            },
            {
                id: 20,
                question: "Direct: 'I have never been to China,' he said.",
                options: [
                    "He said he has never been to China.",
                    "He said he had never been to China.",
                    "He said he never went to China.",
                    "He said he was never in China."
                ],
                correct: 1,
                explanation: "Present perfect (have been) changes to past perfect (had been)."
            }
        ];

        // Prevent accidental refresh
        window.addEventListener('beforeunload', function (e) {
            if (testStarted) {
                e.preventDefault();
                e.returnValue = 'Are you sure you want to leave? Your test progress will be lost!';
                return e.returnValue;
            }
        });

        function startTest() {
            const nameInput = document.getElementById('studentName');
            if (!nameInput.value.trim()) {
                alert('Please enter your name');
                return;
            }
            
            studentName = nameInput.value.trim();
            testStarted = true;
            
            // Show timer and test screen
            document.getElementById('timer').style.display = 'flex';
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('testScreen').style.display = 'block';
            document.getElementById('backToStart').style.display = 'block';
            
            // Start timer
            startTimer();
            
            // Load all questions
            loadAllQuestions();
        }

        function startTimer() {
            updateTimer();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimer();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitTest();
                }
            }, 1000);
        }

        function updateTimer() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('time').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
            // Change color when less than 5 minutes
            if (timeLeft <= 300) {
                document.getElementById('timer').style.background = '#dc2626';
            }
        }

        function loadAllQuestions() {
            const container = document.getElementById('questionsContainer');
            let questionsHTML = '';
            
            questions.forEach((q, index) => {
                questionsHTML += `
                    <div class="question" id="question-${index}">
                        <div class="question-number">
                            Question ${index + 1}
                            <span class="question-status status-unanswered" id="status-${index}">Not answered</span>
                        </div>
                        <div class="question-text">${q.question}</div>
                        <div class="options">
                            ${q.options.map((option, optionIndex) => `
                                <div class="option" onclick="selectAnswer(${index}, ${optionIndex})" id="option-${index}-${optionIndex}">
                                    <span class="option-label">${String.fromCharCode(65 + optionIndex)}</span>
                                    ${option}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = questionsHTML;
        }

        function selectAnswer(questionIndex, answerIndex) {
            // Remove selected class from all options in this question
            for (let i = 0; i < 4; i++) {
                const option = document.getElementById(`option-${questionIndex}-${i}`);
                option.classList.remove('selected');
            }
            
            // Add selected class to chosen option
            const selectedOption = document.getElementById(`option-${questionIndex}-${answerIndex}`);
            selectedOption.classList.add('selected');
            
            // Update answer in array
            answers[questionIndex] = answerIndex;
            
            // Update status
            document.getElementById(`status-${questionIndex}`).textContent = 'Answered';
            document.getElementById(`status-${questionIndex}`).className = 'question-status status-unanswered';
        }

        function checkAllAnswered() {
            const unanswered = questions.length - Object.keys(answers).length;
            
            if (unanswered === 0) {
                alert('‚úÖ All questions answered! You can submit now.');
            } else {
                alert(`‚ö†Ô∏è You have ${unanswered} unanswered question${unanswered > 1 ? 's' : ''}. Please answer all questions before submitting.`);
                
                // Scroll to first unanswered question
                for (let i = 0; i < questions.length; i++) {
                    if (answers[i] === undefined) {
                        document.getElementById(`question-${i}`).scrollIntoView({ behavior: 'smooth' });
                        break;
                    }
                }
            }
        }

        async function submitTest() {
            clearInterval(timerInterval);
            
            // Calculate score
            score = 0;
            const userAnswers = [];
            const timeUsed = TEST_DURATION - timeLeft;
            const minutes = Math.floor(timeUsed / 60);
            const seconds = timeUsed % 60;
            const timeFormatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            questions.forEach((q, index) => {
                const userAnswer = answers[index];
                const isCorrect = userAnswer === q.correct;
                
                if (isCorrect) score++;
                
                userAnswers.push({
                    question: q.question,
                    userAnswer: userAnswer !== undefined ? q.options[userAnswer] : 'Not answered',
                    correctAnswer: q.options[q.correct],
                    isCorrect: isCorrect,
                    explanation: q.explanation
                });
                
                // Mark question for review
                const questionElement = document.getElementById(`question-${index}`);
                const statusElement = document.getElementById(`status-${index}`);
                
                if (userAnswer === undefined) {
                    questionElement.classList.add('incorrect');
                    statusElement.textContent = 'Not answered';
                    statusElement.className = 'question-status status-incorrect';
                } else if (isCorrect) {
                    questionElement.classList.add('correct');
                    statusElement.textContent = 'Correct';
                    statusElement.className = 'question-status status-correct';
                } else {
                    questionElement.classList.add('incorrect');
                    statusElement.textContent = 'Incorrect';
                    statusElement.className = 'question-status status-incorrect';
                    
                    // Mark the correct answer
                    const correctOption = document.getElementById(`option-${index}-${q.correct}`);
                    correctOption.classList.add('correct-answer');
                    
                    // Mark the wrong answer if selected
                    const wrongOption = document.getElementById(`option-${index}-${userAnswer}`);
                    wrongOption.classList.add('wrong-answer');
                }
            });
            
            const percentage = Math.round((score / questions.length) * 100);
            
            // Show loading screen
            document.getElementById('testScreen').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'block';
            
            try {
                // Send report to Telegram
                await fetch('/api/submit-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: studentName,
                        score: score,
                        total: questions.length,
                        timeUsed: timeFormatted,
                        answers: userAnswers,
                        percentage: percentage
                    })
                });
                
                // Show results
                showResults(score, questions.length, timeFormatted, userAnswers);
            } catch (error) {
                console.error('Error:', error);
                // Still show results even if Telegram fails
                showResults(score, questions.length, timeFormatted, userAnswers);
            }
        }

        function showResults(score, total, timeUsed, userAnswers) {
            const percentage = Math.round((score / total) * 100);
            const incorrectCount = total - score;
            
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'block';
            document.getElementById('backToStart').style.display = 'none';
            
            // Update result display
            document.getElementById('finalScore').textContent = `${score}/${total}`;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('correctCount').textContent = score;
            document.getElementById('incorrectCount').textContent = incorrectCount;
            document.getElementById('percentage').textContent = `${percentage}%`;
            document.getElementById('timeUsed').textContent = timeUsed;
            
            // Set result message
            let message = '';
            if (percentage >= 90) {
                message = 'üéâ Excellent! Perfect understanding of reported speech!';
            } else if (percentage >= 80) {
                message = 'üëç Very good! Strong grasp of reported speech rules.';
            } else if (percentage >= 70) {
                message = '‚úÖ Good job! You understand most reported speech concepts.';
            } else if (percentage >= 60) {
                message = 'üìö Fair. Review the rules and practice more.';
            } else {
                message = 'üìñ Needs improvement. Study the tense changes in reported speech.';
            }
            
            document.getElementById('resultMessage').textContent = message;
            
            // Store answers for review mode
            window.userAnswers = userAnswers;
        }

        function showReviewMode() {
            document.getElementById('resultScreen').style.display = 'none';
            document.getElementById('reviewScreen').style.display = 'block';
            
            const reviewContainer = document.getElementById('reviewContainer');
            let reviewHTML = '';
            
            window.userAnswers.forEach((answer, index) => {
                const questionNum = index + 1;
                const isCorrect = answer.isCorrect;
                
                reviewHTML += `
                    <div class="question ${isCorrect ? 'correct' : 'incorrect'}" style="margin-bottom: 20px;">
                        <div class="question-number">
                            Question ${questionNum}
                            <span class="question-status ${isCorrect ? 'status-correct' : 'status-incorrect'}">
                                ${isCorrect ? 'Correct' : 'Incorrect'}
                            </span>
                        </div>
                        <div class="question-text">${answer.question}</div>
                        
                        <div style="margin: 15px 0;">
                            <div style="display: flex; gap: 20px; margin-bottom: 10px;">
                                <div style="flex: 1; padding: 10px; background: ${isCorrect ? '#d1fae5' : '#fee2e2'}; border-radius: 6px;">
                                    <strong>Your Answer:</strong><br>
                                    ${answer.userAnswer}
                                </div>
                                ${!isCorrect ? `
                                    <div style="flex: 1; padding: 10px; background: #d1fae5; border-radius: 6px;">
                                        <strong>Correct Answer:</strong><br>
                                        ${answer.correctAnswer}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div style="padding: 12px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #0ea5e9; margin-top: 10px;">
                                <strong>üí° Explanation:</strong> ${answer.explanation}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            reviewContainer.innerHTML = reviewHTML;
        }

        function hideReviewMode() {
            document.getElementById('reviewScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'block';
        }

        function showStartScreen() {
            if (testStarted && !confirm('Are you sure you want to go back to start? Your test progress will be lost!')) {
                return;
            }
            
            testStarted = false;
            clearInterval(timerInterval);
            
            document.getElementById('testScreen').style.display = 'none';
            document.getElementById('resultScreen').style.display = 'none';
            document.getElementById('reviewScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('timer').style.display = 'none';
            document.getElementById('backToStart').style.display = 'none';
            
            // Reset variables
            timeLeft = TEST_DURATION;
            answers = [];
            score = 0;
        }

        // Handle refresh warning
        window.addEventListener('beforeunload', function(e) {
            if (testStarted) {
                e.preventDefault();
                document.getElementById('refreshWarning').style.display = 'flex';
                return '';
            }
        });

        function cancelRefresh() {
            document.getElementById('refreshWarning').style.display = 'none';
        }

        function confirmRefresh() {
            document.getElementById('refreshWarning').style.display = 'none';
            location.reload();
        }

        // Add right-click context menu prevention
        document.addEventListener('contextmenu', function(e) {
            if (testStarted) {
                e.preventDefault();
                return false;
            }
        });

        // Add keyboard shortcuts prevention
        document.addEventListener('keydown', function(e) {
            if (testStarted && (e.ctrlKey || e.metaKey) && (e.key === 'r' || e.key === 'R')) {
                e.preventDefault();
                document.getElementById('refreshWarning').style.display = 'flex';
            }
        });
    </script>
</body>
</html>
